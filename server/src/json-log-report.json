// scripts/build-json-log-report.js
const fs = require("fs");
const path = require("path");

const logPath = path.join(__dirname, "..", "server", "src", "job-logs.ndjson");
const outPath = path.join(__dirname, "..", "server", "src", "json-log-report.json");

if (!fs.existsSync(logPath)) {
  fs.writeFileSync(outPath, JSON.stringify({ count: 0 }) + "\n", "utf8");
  console.log("No job-logs.ndjson yet.");
  process.exit(0);
}

const lines = fs.readFileSync(logPath, "utf8").trim().split("\n");
const entries = lines.slice(-50).map((l) => JSON.parse(l));

const report = {
  generatedAt: new Date().toISOString(),
  totalEntries: lines.length,
  lastErrors: entries.filter((e) => e.level === "ERROR").slice(-5),
};

fs.writeFileSync(outPath, JSON.stringify(report, null, 2) + "\n", "utf8");
console.log("Updated json-log-report.json");
